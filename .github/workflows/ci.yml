name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Check required files exist
        run: |
          echo "Checking for required files..."
          
          if [ ! -f "manifest.json" ]; then
            echo "❌ ERROR: manifest.json is missing"
            exit 1
          fi
          echo "✅ manifest.json exists"
          
          if [ ! -f "versions.json" ]; then
            echo "❌ ERROR: versions.json is missing (required for BRAT)"
            exit 1
          fi
          echo "✅ versions.json exists"
          
          if [ ! -f "package.json" ]; then
            echo "❌ ERROR: package.json is missing"
            exit 1
          fi
          echo "✅ package.json exists"

      - name: Validate manifest.json structure
        run: |
          echo "Validating manifest.json structure..."
          
          if ! jq empty manifest.json 2>/dev/null; then
            echo "❌ ERROR: manifest.json is not valid JSON"
            exit 1
          fi
          echo "✅ manifest.json is valid JSON"
          
          REQUIRED_FIELDS=("id" "name" "version" "minAppVersion" "description")
          
          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! jq -e ".$field" manifest.json > /dev/null 2>&1; then
              echo "❌ ERROR: manifest.json is missing required field: $field"
              exit 1
            fi
            echo "✅ Found required field: $field"
          done
          
          if ! jq -e 'has("isDesktopOnly")' manifest.json > /dev/null 2>&1; then
            echo "❌ ERROR: manifest.json is missing required field: isDesktopOnly"
            exit 1
          fi
          echo "✅ Found required field: isDesktopOnly"
          
          VERSION=$(jq -r '.version' manifest.json)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ ERROR: version must follow Semantic Versioning (x.y.z), found: $VERSION"
            exit 1
          fi
          echo "✅ Version follows SemVer: $VERSION"
          
          MIN_VERSION=$(jq -r '.minAppVersion' manifest.json)
          if ! echo "$MIN_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ ERROR: minAppVersion must follow Semantic Versioning (x.y.z), found: $MIN_VERSION"
            exit 1
          fi
          echo "✅ minAppVersion follows SemVer: $MIN_VERSION"

      - name: Validate versions.json structure
        run: |
          echo "Validating versions.json structure..."
          
          if ! jq empty versions.json 2>/dev/null; then
            echo "❌ ERROR: versions.json is not valid JSON"
            exit 1
          fi
          echo "✅ versions.json is valid JSON"
          
          if [ "$(jq -r 'type' versions.json)" != "object" ]; then
            echo "❌ ERROR: versions.json must be a JSON object"
            exit 1
          fi
          echo "✅ versions.json is a valid object"
          
          MANIFEST_VERSION=$(jq -r '.version' manifest.json)
          if ! jq -e ".[\"$MANIFEST_VERSION\"]" versions.json > /dev/null 2>&1; then
            echo "❌ ERROR: Current version ($MANIFEST_VERSION) not found in versions.json"
            echo "   This is required for BRAT compatibility"
            exit 1
          fi
          echo "✅ Current version exists in versions.json"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run linting
        run: npm run lint

      - name: Build plugin
        run: npm run build

      - name: Check build artifacts
        run: |
          echo "Checking build artifacts..."
          
          if [ ! -f "main.js" ]; then
            echo "❌ ERROR: main.js not found after build (required for Obsidian & BRAT)"
            exit 1
          fi
          echo "✅ main.js exists"
          
          if [ ! -s "main.js" ]; then
            echo "❌ ERROR: main.js is empty"
            exit 1
          fi
          echo "✅ main.js is not empty ($(du -h main.js | cut -f1))"
          
          if [ -f "styles.css" ]; then
            echo "✅ styles.css exists (optional)"
          else
            echo "ℹ️  INFO: styles.css not found (optional)"
          fi

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "=================================================="
          echo "✅ CI Validation: PASSED (Node ${{ matrix.node-version }})"
          echo "=================================================="
          echo ""
          echo "Plugin Details:"
          echo "  ID: $(jq -r '.id' manifest.json)"
          echo "  Name: $(jq -r '.name' manifest.json)"
          echo "  Version: $(jq -r '.version' manifest.json)"
          echo "  Min Obsidian Version: $(jq -r '.minAppVersion' manifest.json)"
          echo "  Desktop Only: $(jq -r '.isDesktopOnly' manifest.json)"
          echo ""
          echo "✅ Linting passed"
          echo "✅ Build successful"
          echo "✅ BRAT compatible"
          echo ""
